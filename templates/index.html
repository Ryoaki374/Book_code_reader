<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>書籍バーコードリーダー</title>
  <style>
    /* カメラ映像や表のスタイル */
    #scanner-container { width: 300px; height: 200px; border: 1px solid #ccc; }
    table { margin-top: 20px; border-collapse: collapse; }
    th, td { padding: 8px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>書籍バーコードリーダー</h1>
  
  <!-- カメラ映像表示エリア -->
  <div id="scanner-container">
    <video id="video" width="300" height="200" autoplay></video>
  </div>
  
  <!-- 読み取ったバーコードを常時表示 -->
  <p>現在のバーコード: <span id="barcode-display">なし</span></p>
  
  <!-- スキャン開始ボタンとリクエスト送信ボタン -->
  <button id="start-scan">スキャン開始</button>
  <button id="send-request">リクエスト送信</button>
  
  <!-- 書籍情報を表示する表 -->
  <table>
    <thead>
      <tr>
        <th>バーコード</th>
        <th>書名</th>
        <th>著者名</th>
        <th>出版社</th>
        <th>発行年</th>
      </tr>
    </thead>
    <tbody id="book-table-body"></tbody>
  </table>
  
  <br>
  <!-- CSVダウンロードリンク -->
  <a href="/download_csv" target="_blank">CSVダウンロード</a>
  
  <!-- QuaggaJS の読み込み（CDN 利用） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script>
    // スキャン開始ボタンの処理
    document.getElementById('start-scan').addEventListener('click', function() {
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#scanner-container')
        },
        decoder: {
          readers: ["ean_reader"]
        }
      }, function(err) {
        if (err) {
          console.error(err);
          return;
        }
        console.log("カメラ準備完了");
        Quagga.start();
      });
  
      // 検出されたバーコードを常時表示する
      Quagga.onDetected(function(result) {
        var barcode = result.codeResult.code;
        console.log("検出したバーコード: " + barcode);
        document.getElementById('barcode-display').textContent = barcode;
      });
    });
  
    // リクエスト送信ボタンの処理
    document.getElementById('send-request').addEventListener('click', function() {
      var barcode = document.getElementById('barcode-display').textContent;
      if (!barcode || barcode === 'なし') {
        alert('有効なバーコードが読み取られていません。');
        return;
      }
  
      // サーバ側の /lookup エンドポイントへPOSTリクエスト送信
      fetch('/lookup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ barcode: barcode })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          let book = data.book;
          // ポップアップメッセージに書籍情報を表示
          let message = `タイトル: ${book.title}\n著者: ${book.authors}\n出版社: ${book.publisher}\n発行年: ${book.publishedDate}`;
          if (confirm("以下の書籍情報が見つかりました:\n" + message + "\n\n登録しますか？\n[OK]=entry, [キャンセル]=abort")) {
            // entry を選択した場合、表に登録
            addBookToTable(book);
          } else {
            // cancel を選択した場合は abort（何もしない）
            console.log("登録をキャンセルしました。");
          }
        } else {
          alert(data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert("リクエスト送信中にエラーが発生しました。");
      });
    });
  
    // 書籍情報を表に追加する関数
    function addBookToTable(book) {
      var tbody = document.getElementById('book-table-body');
      var tr = document.createElement('tr');
  
      var tdBarcode = document.createElement('td');
      tdBarcode.textContent = book.barcode;
      tr.appendChild(tdBarcode);
  
      var tdTitle = document.createElement('td');
      tdTitle.textContent = book.title;
      tr.appendChild(tdTitle);
  
      var tdAuthors = document.createElement('td');
      tdAuthors.textContent = book.authors;
      tr.appendChild(tdAuthors);
  
      var tdPublisher = document.createElement('td');
      tdPublisher.textContent = book.publisher;
      tr.appendChild(tdPublisher);
  
      var tdPublishedDate = document.createElement('td');
      tdPublishedDate.textContent = book.publishedDate;
      tr.appendChild(tdPublishedDate);
  
      tbody.appendChild(tr);
    }
  </script>
</body>
</html>
